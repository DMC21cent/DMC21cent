---
title: "Tests {DMC21cent}"
output: 
  rmarkdown::html_document:
    df_print: paged
    theme: flatly
    highlight: haddock
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_fold: show
---


```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE,
  eval = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width=10,
  fig.height=5,
 # dpi = 85,
  # out.width = "100%",
  # out.height = "50%",
  comment = "#>"
)
library(dplyr)
library(ggplot2)
library(scales)
library(plotly)
devtools::load_all()
```

```{r setup, eval = FALSE}
library(DMC21cent)
```


# Lab Spaghetti Plot


This section illustrates the spaghetti plot for the parameters that all patients have the same unique value for `A1HI` (Analysis Range 1 Upper Limit).

Let's determine which parameters have a unique A1HI and A1LO value for each patient throughout the specified visits.


```{r}
selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment")
adlb <- adlbc

selected_params <- adlb %>%
  dplyr::filter(SAFFL == "Y") %>%
  dplyr::mutate(AVISIT = trimws(AVISIT, "l")) %>%
  dplyr::filter(AVISIT %in% selected_visit) %>%
  group_by(PARAM) %>%
  summarise(unique_A1HI = n_distinct(A1HI),
            unique_A1LO = n_distinct(A1LO)) %>%
  ungroup() %>%
  filter(unique_A1HI == 1,
         unique_A1LO == 1) %>%
  pull(PARAM)

selected_params %>% print()

```

As follows, there is only one `PARAM` from the above list that has an `AVAL` (Analysis Value) larger than three times of the `A1HI` (Analysis Range 1 Upper Limit).

```{r}

adlb %>%
  filter(PARAM %in% selected_params) %>%
  filter(AVAL > 3*A1HI) %>%
  pull(PARAM) %>%
  unique() %>% print()

```


Here, we check the subjects who has `AVAL` (Analysis Value) values higher than `3*A1HI` (Analysis Range 1 Upper Limit)


## Part 1

### First test

```{r}
param_filter = "Bilirubin (umol/L)"
selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment")
adlb <- adlbc



Data <- adlb %>%
  dplyr::select(USUBJID, PARAM, PARAMCD, AVISIT, TRTA, AVAL, A1HI, A1LO) %>%
  dplyr::mutate(AVISIT = trimws(AVISIT, "l")) %>%
  dplyr::filter(PARAM %in% param_filter) %>%
  dplyr::filter(AVISIT %in% selected_visit) %>%
  dplyr::mutate(AVISTTF = factor(AVISIT, levels = selected_visit)) %>%
  dplyr::filter(!is.na(AVAL))
  
  
selected_ids <- Data %>%
  dplyr::filter(AVAL > 3* A1HI) %>% 
  pull(USUBJID)

Data %>%
  filter(USUBJID %in% selected_ids) %>%
  select(USUBJID, TRTA, AVISTTF, AVAL, A1HI, A1LO) %>%
  kableExtra::kable() %>%
    kableExtra::kable_styling(font_size = 14,
                              full_width = F,
                              #latex_options = "HOLD_position",
                              position = "center")

```

We can confirm the selected patient is the one showed in the output of the following function.

```{r}
lab_spaghetti(adlb = adlbc,
              param_filter = "Bilirubin (umol/L)",
              selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment"))

```






## Part 2

### First test

For parameters for which no unique `A1HI` exists, we compare each patient's `AVAL` to their own  '`A1HI` and pick those with at least one `AVAL` more than three times their own `A1HI`.

```{r}
param_filter = "Creatine Kinase (U/L)"
selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment")
adlb <- adlbc



Data <- adlb %>%
  dplyr::select(USUBJID, PARAM, PARAMCD, AVISIT, TRTA, AVAL, A1HI, A1LO) %>%
  dplyr::mutate(AVISIT = trimws(AVISIT, "l")) %>%
  dplyr::filter(PARAM %in% param_filter) %>%
  dplyr::filter(AVISIT %in% selected_visit) %>%
  dplyr::mutate(AVISTTF = factor(AVISIT, levels = selected_visit)) %>%
  dplyr::filter(!is.na(AVAL))
  
  
selected_ids <- Data %>%
  dplyr::filter(AVAL > 3* A1HI) %>% 
  pull(USUBJID)

Data %>%
  filter(USUBJID %in% selected_ids) %>%
  select(USUBJID, TRTA, AVISTTF, AVAL, A1HI, A1LO) %>%
  kableExtra::kable() %>%
    kableExtra::kable_styling(font_size = 14,
                              full_width = F,
                              #latex_options = "HOLD_position",
                              position = "center")

```

Here, we can confirm that the patients chosen are identical to those generated by the following plot.


```{r}
lab_spaghetti(adlb = adlbc,
              param_filter = "Creatine Kinase (U/L)",
              axis_tick_size = 8,
              x_axis_wrap = 6,
              selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment"))

```

### Second test


```{r}
param_filter = "Alanine Aminotransferase (U/L)"
selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment")
adlb <- adlbc



Data <- adlb %>%
  dplyr::select(USUBJID, PARAM, PARAMCD, AVISIT, TRTA, AVAL, A1HI, A1LO) %>%
  dplyr::mutate(AVISIT = trimws(AVISIT, "l")) %>%
  dplyr::filter(PARAM %in% param_filter) %>%
  dplyr::filter(AVISIT %in% selected_visit) %>%
  dplyr::mutate(AVISTTF = factor(AVISIT, levels = selected_visit)) %>%
  dplyr::filter(!is.na(AVAL))
  
  
selected_ids <- Data %>%
  dplyr::filter(AVAL > 3* A1HI) %>% 
  pull(USUBJID)

Data %>%
  filter(USUBJID %in% selected_ids) %>%
  select(USUBJID, TRTA, AVISTTF, AVAL, A1HI, A1LO) %>%
  kableExtra::kable() %>%
    kableExtra::kable_styling(font_size = 14,
                              full_width = F,
                              #latex_options = "HOLD_position",
                              position = "center")

```

Here, we can confirm that the patients chosen are identical to those generated by the following plot.


```{r}
lab_spaghetti(adlb = adlbc,
              param_filter = "Alanine Aminotransferase (U/L)",
              axis_tick_size = 8,
              x_axis_wrap = 6,
              selected_visit = c("Baseline", "Week 2", "Week 4", "Week 6", "Week 8", "End of Treatment"))

```


